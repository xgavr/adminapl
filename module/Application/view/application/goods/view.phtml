<?php
$this->headTitle($goods->getCode().' '.$goods->getProducer()->getName().' '.$goods->getName());

$this->mainMenu()->setActiveItemId('rb');

$this->pageBreadcrumbs()->setItems([
            'Главная'=>$this->url('home'),
            'Товары'=>$this->url('goods'),
            $goods->getName()=>$this->url('goods', ['action'=>'view', 'id'=>$goods->getId()])
            ]);

$this->headLink()
//    ->appendStylesheet('https://cdnjs.cloudflare.com/ajax/libs/jquery-bootgrid/1.3.1/jquery.bootgrid.css')        
    ->appendStylesheet('//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.css')        
        ;

$this->headScript()
    ->appendFile('//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js')
    ->appendFile('//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/locale/bootstrap-table-ru-RU.min.js')
            ; 

?>

<style>
    .modal-body {
        height: 400px;
        overflow-y: scroll;
    }    
</style>

<h1>
    <?php if ($goods->getName()): ?>
        <?= $this->escapeHtml($goods->getName()); ?>
        <? if ($goods->getAplId()):?>
            <sup>
                <button value="/apl/update-good-name/<?= $goods->getId()?>" class="btn btn-info btn-xs refresh-table-button"
                        title="Обновить наименование в АПЛ">
                    <span class="glyphicon glyphicon-refresh" ></span>
                </button>         
            </sup>
        <? endif;?>
    <? endif;?>
</h1>

<h3>
    <button value="/goods/update-bestname/<?= $goods->getId()?>" class="btn btn-info btn-xs refresh-table-button"
            title="Обновить наименование">
        <span class="glyphicon glyphicon-refresh" ></span>
    </button> 
    <span>
        <?= ($bestName) ? $bestName:'Нет наименования';?>
    </span>    
</h3>
<h4>
    <?= $goods->getGenericGroup()->getName().' ('.$goods->getGenericGroup()->getTdId().')';?>
</h4>    
<h5>
    <?php if ($goods->getTokenGroup()):?>
        <?= $goods->getTokenGroup()->getName();?>
    <?php else: ?>
        Группа наименований не назначена
    <?php endif?>
</h5>    
<h6>
    <button value="/name/goods-token-group/<?= $goods->getId()?>" class="btn btn-info btn-xs refresh-table-button"
            title="Присвоить группу наименований">
        <span class="glyphicon glyphicon-refresh" ></span>
    </button> 
    <?php if ($goods->getTokenGroup()):?>
        <span>
            <a href="/name/view-token-group/<?= $goods->getTokenGroup()->getId()?>" target="_blank">
                <?= $goods->getTokenGroup()->getTokenView();?>
            </a>
        </span>    
    <?php endif?>
</h6>

<div class="row">
    <div class="col-md-9">

        <table class="table table-striped">
            <tr>
                <td colspan="3">            
                    <?php if ($prev):?>
                        <a href="/goods/view/<?= $prev[0]->getId()?>">&larr;<?= $prev[0]->getCode()?></a>
                    <?php endif;?>            
                </td>
                <td colspan="3" align="right">
                    <?php if ($next):?>
                        <a href="/goods/view/<?= $next[0]->getId()?>"><?= $next[0]->getCode()?>&rarr;</a>
                    <?php endif;?>                            
                </td>
            </tr>
            <tr>
                <th>

                </th>
                <th>
                    <?//= $randRawprices[0]->getUnknownProducer()->getName()?>
                </th>
                <td colspan="3" align="right">
                </td>
                <td align="right">
                </td>
            </tr>
            <?php $totalRawpriceCount = 0; ?>
            <?php foreach ($rawprices as $rawprice):?>
                <tr style="font-size: <?= ($rawprice->getStatus() == $rawprice::STATUS_PARSED) ? "inherit":"xx-small"?>">
                    <td>
                        <a href="<?= $this->url('producer', ['action' => 'article-view', 'id' => $rawprice->getCode()->getId()]);?>">
                            <?= $rawprice->getArticle();?>
                        </a> 
                        <div>
                            <?= $rawprice->getStatusAsString();?>
                        </div>
                    </td>
                    <td>
                        <div>
                            <a href="<?= $this->url('supplier', ['action' => 'view', 'id' => $rawprice->getRaw()->getSupplier()->getId()]);?>">
                                <?= $rawprice->getRaw()->getSupplier()->getName();?>
                            </a>                       
                        </div>
                        <div>
                            <a href="<?= $this->url('producer', ['action' => 'unknown-view', 'id' => $rawprice->getUnknownProducer()->getId()]);?>">
                                <?= $rawprice->getUnknownProducer()->getName();?>
                            </a>                       
                        </div>
                    </td>
                    <td>
                        <a href="<?= $this->url('rawprice', ['action' => 'view', 'id' => $rawprice->getId()]);?>">
                            <?= $rawprice->getGoodname();?>
                        </a>    
                        <?php $tokens = $rawprice->getTokens(); ?>
                        <?php if(count($tokens)):?>  
                            <div>    
                                <?php foreach($tokens as $token):?>
                                    <span style="font-size: xx-small; font-weight: <?= ($token->getStatus() == $token::IS_DICT) ? 'bold':'normal' ?>">
                                        <a href="/name/view-token/<?= $token->getId() ?>"><?= $token->getLemma() ?></a>
                                    </span>
                                <?php endforeach;?>
                            </div>        
                        <?php endif;?>                                                
                    </td>
                    <td>
                        <?php $oemIntersect = $articleManager->oemRawpricesIntersect($rawprices, $rawprice); ?>
                        <?php foreach($rawprice->getOemRaw() as $oemRaw): ?>
                            <a href="<?= $this->url('oem', ['action' => 'view-on-code'], ['query' => ['code' => $oemRaw->getCode()]]);?>">
                                <span style="font-size: xx-small; color: <?= (in_array($oemRaw->getCode(), $oemIntersect)) ? 'green':'inherit' ?>"><?= $oemRaw->getCode()?></span>
                            </a>    
                        <?php endforeach;?>
                    </td>
                    <td align="right">
                        <?= number_format($rawprice->getRealPrice(), 2, '.', '');?>
                    </td>
                    <td align="right">
                        <?= $rawprice->getRealRest();?>
                    </td>
                </tr>
            <?php endforeach;?>        
            <tr>
                <th colspan="4">
                    Всего
                </th>
                <td align="right">
                </td>
                <td align="right">
                    <b><?//= $totalRawpriceCount ?></b>
                </td>
            </tr>
        </table>
        <div>
            <?php foreach($images as $key => $imageFolder):?>
                <?php foreach ($imageFolder as $path): ?>
                    <img src="<?= $path ?>" alt="<?= $key ?>" height="100">
                <?php endforeach;?>            
            <?php endforeach;?>
        </div>
        
        <ul class="nav nav-tabs" id="featureTab" role="tablist">
            <li role="presentation" class="active"><a href="#home" role="tab" id="home-tab" data-toggle="tab" aria-controls="home" aria-expanded="true">Описание</a></li>
            <li role="presentation"><a href="#oem" role="tab" id="profile-tab" data-toggle="tab" aria-controls="oem" aria-expanded="true">Номера <span id="oemBadge" class="badge">0</span></a></li>
            <li role="presentation"><a href="#linked" role="tab" id="linked-tab" data-toggle="tab" aria-controls="linked" aria-expanded="true">Применимость <span id="linkedBadge" class="badge">0</span></a></li>
        </ul>
        
        <div class="tab-content" id="featureTabContent">
            <div class="tab-pane" role="tabpanel" id="home" aria-labelledby="home-tab">
                <p>
                    <?php foreach ($goods->getAttributes() as $attr):?>
                        <span><?= $attr->getName()?>:</span> <span><?= $attr->getValue()->getValue();?></span> 
                    <?php endforeach;?>
                </p>
            </div>
            <div class="tab-pane fade" role="tabpanel" id="oem" aria-labelledby="oem-tab">
                <div id="oemToolbar">
                    <div class="form-inline" role="form">
                        <button value="/oem/oem-form/<?= $goods->getId() ?>" type="button" class="btn btn-default" title="Добавить" data-toggle="modal" data-target="#modal-dialog">
                            <span class="glyphicon glyphicon-plus"></span>
                        </button>
                        <div class="form-group">
                            <input name="search" style="width: 200px" class="form-control" type="text" placeholder="Поиск">
                        </div>
                        <button id="oemOk" type="submit" class="btn btn-default">OK</button>
                    </div>
                </div>
                <table id="oemTable" 
                    data-toggle="table" 
                    data-url="/goods/oem-content/<?= $goods->getId()?>"
                    data-side-pagination="server"
                    data-pagination="true" 
                    data-page-list="[5, 10, 20, 50]"
                    data-toolbar="#oemToolbar"
                    data-show-refresh="true"
                    data-show-toggle="true"
                    data-query-params="oemQueryParams"
                    data-response-handler="responseHandler"
                    >
                    <thead>
                        <tr>
                             <th data-field="id" data-type="numeric">ID</th>
                             <th data-field="oeNumber" data-type="numeric">Номер</th>
                             <th data-field="brandName">Бренд</th>
                             <th data-field="source" data-formatter="sourceFormatter">Источник</th>
                             <th data-field="status" data-formatter="statusFormatter">Статус</th>
                             <th data-field="status" data-formatter="oemActiveFormatter"></th>
                        </tr>                
                    </thead>
                </table>
            </div>
            <div class="tab-pane fade" role="tabpanel" id="linked" aria-labelledby="linked-tab">
                <table id="linkedTable" 
                    data-toggle="table" 
                    data-url="/goods/car-content/<?= $goods->getId()?>"
                    data-side-pagination="server"
                    data-pagination="true" 
                    data-page-list="[5, 10, 20, 50]"
                    data-toolbar="#linkedToolbar"
                    data-show-refresh="true"
                    data-show-toggle="true"
                    data-query-params="linkedQueryParams"
                    data-response-handler="responseHandler"
                    >
                    <thead>
                        <tr>
                             <th data-field="id" data-type="numeric">ID</th>
                             <th data-field="tdId" data-type="numeric">TD</th>
                             <th data-field="aplId" data-type="numeric">APL</th>
                             <th data-field="name" data-formatter="carFormatter">Машина</th>
                         </tr>                
                    </thead>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-3" id="side-nav" >
        <div class="nav nav-stacked nav-list affix">
            <div class="panel-group">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <span>
                            <a href="/producer/article-view/?code=<?=$goods->getCode()?>">
                                <?= $goods->getCode();?>
                            </a>
                        </span>
                        <span>
                            <a href="/producer/view/<?=$goods->getProducer()->getId()?>">
                                <?= $goods->getProducer()->getName();?>
                            </a>
                        </span>    
                    </div>
                    <div class="panel-body">
                        <div class="pull-left">
                            AplId: 
                            <?php if ($goods->getAplId()): ?>
                            <a href="https://autopartslist.ru/goods/view/id/<?= $goods->getAplId() ?>" target="_blank">
                                    <?= $goods->getAplId()?>
                                </a>
                            <?php else: ?>
                                <?= $goods->getAplId()?>
                            <? endif; ?>    
                        </div>
                        <div class="pull-right">
                            <button value="/apl/good-apl-id/<?= $goods->getId()?>" class="btn btn-info btn-xs refresh-table-button"
                                    title="Обновить АПЛ Ид">
                                <span class="glyphicon glyphicon-refresh" ></span>
                            </button>                             
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="pull-left">
                            Поиск в TecDoc: 
                        </div>
                        <div class="pull-right">
                            <button value="/goods/external-api-search/<?= $goods->getId()?>" class="btn btn-info btn-xs show-button"
                                    title="Посик в TecDocId">
                                <span class="glyphicon glyphicon-refresh" ></span>
                            </button>                             
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="pull-left">
                            TecDocId: 
                        </div>
                        <div class="pull-right">
                            <button value="/goods/external-api/<?= $goods->getId()?>" class="btn btn-info btn-xs show-button"
                                    title="Обновить TecDocId">
                                <span class="glyphicon glyphicon-refresh" ></span>
                            </button>                             
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="pull-left">
                            TecDoc группа: 
                        </div>
                        <div class="pull-right">
                            <button value="/goods/generic-group/<?= $goods->getId()?>" class="btn btn-default btn-xs refresh-table-button"
                                    title="Обновить группу">
                                <span class="glyphicon glyphicon-refresh" ></span>
                            </button>                             
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="pull-left">
                            TecDoc описание: 
                        </div>
                        <div class="pull-right">
                            <button value="/goods/attribute/<?= $goods->getId()?>" class="btn btn-default btn-xs refresh-table-button"
                                    title="Обновить описание">
                                <span class="glyphicon glyphicon-refresh" ></span>
                            </button>                             
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="pull-left">
                            TecDoc номера: 
                        </div>
                        <div class="pull-right">
                            <button value="/goods/good-oem/<?= $goods->getId()?>" class="btn btn-default btn-xs refresh-table-button"
                                    title="Обновить номера">
                                <span class="glyphicon glyphicon-refresh" ></span>
                            </button>                             
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="pull-left">
                            TecDoc машины: 
                        </div>
                        <div class="pull-right">
                            <button value="/goods/external-api-car/<?= $goods->getId()?>" class="btn btn-info btn-xs show-button"
                                    title="Обновить TecDocId">
                                <span class="glyphicon glyphicon-refresh" ></span>
                            </button>                             
                            <button value="/goods/good-cars/<?= $goods->getId()?>" class="btn btn-default btn-xs refresh-table-button"
                                    title="Обновить машины">
                                <span class="glyphicon glyphicon-refresh" ></span>
                            </button>                             
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="pull-left">
                            TecDoc Картинка: 
                        </div>
                        <div class="pull-right">
                            <button value="/goods/external-api-image/<?= $goods->getId()?>" class="btn btn-info btn-xs refresh-table-button"
                                    title="Обновить картинку из TecDoc">
                                <span class="glyphicon glyphicon-refresh" ></span>
                            </button>                             
                        </div>
                    </div>
                </div>    
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $('#featureTab a').click(function (e) {
        e.preventDefault()
        $(this).tab('show')
    })
    
    function refreshLinkedTable(){
        $('#linkedTable').bootstrapTable('refresh');
    }

    function refreshOemTable(){
        $('#oemTable').bootstrapTable('refresh');
    }

    var linkedTable = $('#linkedTable').bootstrapTable({
        onLoadSuccess: function(res){
            $('#linkedBadge').html($('#linkedTable').bootstrapTable('getOptions').totalRows)
        }
    });
    
    var oemTable = $('#oemTable').bootstrapTable({
        onLoadSuccess: function(res){
            $('#oemBadge').html($('#oemTable').bootstrapTable('getOptions').totalRows)
        }
    });
    var oemOk = $('#oemOk');

    $(function () {
        oemOk.click(function () {
            oemTable.bootstrapTable('refresh');
        });
    });
    
    
    
    function tabQueryParams(tab, params) {
        $(tab +'Toolbar').find('input[name]').each(function () {
            params[$(this).attr('name')] = $(this).val();
        });
        limit = $(tab + ' .page-size').html();
        if (limit){
            params.limit = limit;
        }    
        offset = $(tab + ' li.page-number.active a').html();
        if (offset){
            params.offset = params.limit * (offset - 1);
        }    
        
        return params;
    }
    
    function oemQueryParams(params) {
        return tabQueryParams('#oem', params);
    }
    
    function linkedQueryParams(params) {
        return tabQueryParams('#linked', params);
    }
    
    function responseHandler(res) {
        return res;
    }       
    
    function sourceFormatter(value){
        switch(value){
            <?php foreach ($oemSources as $key => $value):?>
                case "<?= $key?>": result="<?= $value?>"; break;      
            <?php endforeach;?>            
            default: result = 'Неизвестно'; break;
        }
        
        return result;
    }    
    
    function statusFormatter(value){
        switch(value){
            <?php foreach ($oemStatuses as $key => $value):?>
                case "<?= $key?>": result="<?= $value?>"; break;      
            <?php endforeach;?>            
            default: result = 'Неизвестно'; break;
        }
        
        return result;
    }    
    
    function oemActiveFormatter(value, row){
        if (value == 1){
            status = 2;
        } else {
            status = 1;
        }            
        var url = '/oem/oem-status-form/'+row.id+'?status='+status;
        var btn = '<button';
        btn += ' type="button"';
        btn += ' class="btn btn-danger btn-xs this-delete"';
        btn += ' aria-label="Left Align"'; 
        btn += ' title="Изменить доступность"'; 
        btn += ' onclick="tableRowDelete(\''+url+'\', \'oemTable\')">';
        btn += '<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>';
        btn += '</button>';
        
        var editUrl = '/oem/oem-form/<?= $goods->getId() ?>?oem='+row.id;
        var editBtn = '<button';
        if (row.source != 3){
            editBtn += ' disabled="disabled"';
        }
        editBtn += ' type="button" data-toggle="modal" data-target="#modal-dialog"';
        editBtn += ' class="btn btn-default btn-xs"';
        editBtn += ' aria-label="Left Align"'; 
        editBtn += ' title="Изменить"'; 
        editBtn += ' value="'+editUrl+'">';
        editBtn += '<span class="glyphicon glyphicon-edit" aria-hidden="true"></span>';
        editBtn += '</button>';
        return editBtn+' '+btn;
    }    
    
    function carFormatter(value, row) {
        return '<a href="/car/view/'+row.id+'" target="_blanc">'+value+'</a>';
    }    
    
    
    $('.show-button').on('click', function(e) {
        var url = e.currentTarget.value;

        if (url){
            var dialog = bootbox.dialog({
                message: '<p class="text-center"><i class="fa fa-spin fa-spinner"></i>Подождите, пока мы что-нибудь сделаем ...</p>',
                closeButton: false
            });

            $.ajax({
                type: 'GET',
                url: url
            })
                .done(function (data) {
                    dialog.modal('hide');
                    dialog = bootbox.dialog({
                        message: '<div><i class="fa fa-spin fa-spinner"></i>'+objectToHtml(data.message)+'</div>',
                        closeButton: true,
                        size: 'large'
                    });
                })
                .fail(function () {
                    dialog.modal('hide');
                    bootbox.alert("Произошла ошибка при выполнении операции.");
                });        
        }        
    })        
</script>
